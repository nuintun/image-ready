{"version":3,"file":"image-ready.js","sources":["../image-ready.ts"],"sourcesContent":["/**\n * @module image-ready\n * @license MIT\n * @author aui\n * @author nuintun\n * @see https://github.com/nuintun/image-ready\n */\n\ninterface Inspector {\n  ready: boolean;\n  check: () => void;\n}\n\ntype ready = (width: number, height: number) => void;\ntype error = () => void;\n\nlet frameId: number = null;\nconst queue: Inspector[] = [];\n\n/**\n * @function remove\n * @description Faster remove array item\n * @param {Array} array\n * @param {number} index\n */\nfunction remove(array: any[], index: number): any {\n  const length: number = array.length;\n\n  if (index >= 0 && index < length) {\n    const last: any = array.pop();\n\n    if (index + 1 < length) {\n      const removed: any = array[index];\n\n      array[index] = last;\n\n      return removed;\n    }\n\n    return last;\n  }\n}\n\nfunction frame() {\n  if (frameId == null) {\n    cancelAnimationFrame(frameId);\n  }\n\n  let i: number = 0;\n\n  while (i < queue.length) {\n    const inspector: Inspector = queue[i];\n\n    inspector.check();\n\n    if (inspector.ready) {\n      remove(queue, i);\n    } else {\n      i++;\n    }\n  }\n\n  if (queue.length) {\n    frameId = requestAnimationFrame(frame);\n  } else {\n    frameId = null;\n  }\n}\n\nfunction getImageWidth(image: HTMLImageElement): number {\n  return image.naturalWidth || image.offsetWidth;\n}\n\nfunction getImageHeigth(image: HTMLImageElement): number {\n  return image.naturalHeight || image.offsetHeight;\n}\n\n/**\n *\n * @param {string} url\n * @param {function} ready\n * @param {function} [error]\n */\nexport default function imageReady(url: string, ready: ready, error?: error) {\n  const image: HTMLImageElement = new Image();\n\n  // 设置图片地址\n  image.src = url;\n\n  // 如果图片被缓存，则直接返回缓存数据\n  if (image.complete) {\n    return ready(image.width, image.height);\n  }\n\n  const accuracy: number = 0;\n  const width: number = getImageWidth(image);\n  const height: number = getImageHeigth(image);\n\n  const imageReady: () => void = () => {\n    inspector.ready = true;\n    image.onload = image.onerror = null;\n  };\n\n  const inspector: Inspector = {\n    ready: false,\n    check() {\n      if (!inspector.ready) {\n        const naturalWidth: number = getImageWidth(image);\n        const naturalHeight: number = getImageHeigth(image);\n\n        if (naturalWidth !== width || naturalHeight !== height || naturalWidth * naturalHeight > accuracy) {\n          imageReady();\n          ready(naturalWidth, naturalHeight);\n        }\n      }\n    }\n  };\n\n  // 完全加载完毕的事件\n  image.onload = function() {\n    imageReady();\n    ready(getImageWidth(image), getImageHeigth(image));\n  };\n\n  // 加载错误后的事件\n  image.onerror = function() {\n    imageReady();\n\n    if (typeof error === 'function') {\n      error();\n    }\n  };\n\n  queue.push(inspector);\n\n  if (frameId == null) {\n    frameId = requestAnimationFrame(frame);\n  }\n}\n"],"names":[],"mappings":"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"}